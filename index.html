<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagos</title>
    
    <!-- Favicon with cache busting -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico?v=2">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico?v=2">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon.ico?v=2">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="./apple-touch-icon.png?v=2">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png?v=2">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#075E54">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Pagos">
    
    <style>
        :root {
            --whatsapp-green-dark: #075E54;
            --whatsapp-green-light: #128C7E;
            --whatsapp-green-accent: #25D366;
            --blue-accent: #34B7F1;
            --red-accent: #e74c3c;
            --orange-accent: #f39c12;
            --light-gray: #f4f4f9;
            --dark-gray: #555;
            --border-color: #ddd;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--light-gray);
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            max-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow: hidden;
            box-sizing: border-box;
        }
        .container {
            background-color: #fff;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 650px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-sizing: border-box;
        }
        h1, h2 {
            color: var(--whatsapp-green-dark);
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 1.5em;
        }
        .section {
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--dark-gray); }
        select, input[type="text"] { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            box-sizing: border-box; 
            font-size: 16px;
            min-height: 44px;
        }
        
        /* Estilos específicos para móviles */
        @media (max-width: 768px) {
            select {
                padding: 16px;
                font-size: 16px;
                min-height: 50px;
                -webkit-appearance: none;
                appearance: none;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 20px;
                padding-right: 50px;
            }
            
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 8px;
                max-height: calc(100vh - 20px);
            }
            
            body {
                padding: 10px;
            }
        }
        button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:active { transform: scale(0.98); }

        /* Estilos de botones */
        .btn-full-width { width: 100%; }
        .btn-generate { background-color: var(--whatsapp-green-light); color: white; margin-bottom: 10px; }
        .btn-generate:hover { background-color: var(--whatsapp-green-dark); }
        .btn-copy { background-color: var(--whatsapp-green-accent); color: white; }
        .btn-copy:hover { background-color: #1DAE54; }

        textarea {
            width: 100%; height: 350px; margin-top: 20px; padding: 15px;
            border: 1px dashed var(--border-color); border-radius: 6px; box-sizing: border-box;
            font-family: monospace; white-space: pre-wrap; background-color: #f9f9f9;
            font-size: 14px; line-height: 1.4;
        }
        
        /* Área de texto personalizada para mostrar formato WhatsApp */
        #output {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #333;
            background: linear-gradient(135deg, #f9f9f9 0%, #ffffff 100%);
            border: 2px solid #e0e0e0;
        }

        /* --- NUEVOS ESTILOS --- */
        #selectedApoderadoInfo {
            background-color: #f0f8ff;
            border: 1px solid #d1e7fd;
            border-radius: 6px;
            padding: 10px;
            margin-top: -5px;
            margin-bottom: 15px;
            font-size: 14px;
            color: var(--dark-gray);
        }
        
        /* Clases para ocultar/deshabilitar elementos */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <!-- SECCIÓN PRINCIPAL DE GENERACIÓN -->
        <div class="section">
            <h1 id="mainTitle">Generador de mensajes</h1>
            <div class="form-group">
                <label for="apoderadoSelector">Selecciona un Apoderado:</label>
                <select id="apoderadoSelector"></select>
            </div>
            <!-- Contenedor para mostrar info del seleccionado -->
            <div id="selectedApoderadoInfo" class="hidden"></div>
            <button id="generateBtn" class="btn-generate btn-full-width">Generar Mensaje</button>
            <div id="output" style="width: 100%; height: 320px; margin-top: 12px; margin-bottom: 20px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 6px; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; white-space: pre-wrap; background: linear-gradient(135deg, #f9f9f9 0%, #ffffff 100%); font-size: 14px; line-height: 1.4; color: #333; overflow-y: auto; cursor: text;" contenteditable="true">Aquí aparecerá el mensaje para copiar...</div>
            <button id="copyBtn" class="btn-copy btn-full-width">Copiar Mensaje</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURACIÓN EDITABLE ---
    const config = {
        valorClase: 35000,
        diasSemana: ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"],
        meses: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
        apoderados: [
            // LUNES
            { 
                apoderado: "Victoria", 
                alumnos: [
                    { nombre: "Juan", hora: "16:30" }, 
                    { nombre: "Amelia", hora: "17:15" }
                ], 
                diaSemana: "Lunes" 
            },
            { 
                apoderado: "Pascale", 
                alumnos: [
                    { nombre: "Martín", hora: "14:30" }, 
                    { nombre: "Emma", hora: "15:15" }
                ], 
                diaSemana: "Lunes" 
            },
            
            // MARTES
            { 
                apoderado: "Esteban", 
                alumnos: [
                    { nombre: "Emilio", hora: "15:45" }, 
                    { nombre: "Josefa", hora: "16:30" }
                ], 
                diaSemana: "Martes" 
            },
            { apoderado: "Amalia", alumnos: [{ nombre: "Lucas", hora: "17:00" }], diaSemana: "Martes" },
            
            // MIÉRCOLES
            { 
                apoderado: "Elisa", 
                alumnos: [
                    { nombre: "Bernardo", hora: "16:20" }, 
                    { nombre: "Samuel", hora: "16:50" }
                ], 
                diaSemana: "Miércoles" 
            },
            { apoderado: "Constanza", alumnos: [{ nombre: "Dante", hora: "15:10" }], diaSemana: "Miércoles" },
            
            // JUEVES
            { 
                apoderado: "Patricia", 
                alumnos: [
                    { nombre: "Patricia", hora: "12:30" }, 
                    { nombre: "Pedro", hora: "15:45" }
                ], 
                diaSemana: "Jueves" 
            },
            { apoderado: "María Paz", alumnos: [{ nombre: "Max", hora: "16:45" }], diaSemana: "Jueves" },
            { apoderado: "Ximena", alumnos: [{ nombre: "Josefa", hora: "18:00" }], diaSemana: "Jueves" },
            { apoderado: "Lupe", alumnos: [{ nombre: "Clarita", hora: "19:45" }], diaSemana: "Jueves" },
            
            // VIERNES
            { apoderado: "Juanita", alumnos: [{ nombre: "Juanita", hora: "10:30" }], diaSemana: "Viernes" },
            { apoderado: "Ignacia", alumnos: [{ nombre: "Clemente", hora: "15:45" }], diaSemana: "Viernes" },
            { apoderado: "Pía", alumnos: [{ nombre: "Agustín", hora: "17:00" }], diaSemana: "Viernes" }
        ]
    };

    // --- DATOS Y VARIABLES GLOBALES (derivados de la configuración) ---
    const apoderados = config.apoderados;
    const VALOR_CLASE = config.valorClase;
    const DIAS_SEMANA = config.diasSemana;
    const meses = config.meses;
    const diasSemanaMap = Object.fromEntries(DIAS_SEMANA.map((dia, i) => [dia, i]));

    // --- ELEMENTOS DEL DOM ---
    const apoderadoSelector = document.getElementById('apoderadoSelector');
    const generateBtn = document.getElementById('generateBtn');
    const copyBtn = document.getElementById('copyBtn');
    const output = document.getElementById('output');
    const selectedApoderadoInfo = document.getElementById('selectedApoderadoInfo');
    const mainTitle = document.getElementById('mainTitle');
    
    // --- FUNCIONES DE UTILIDAD ---
    
    function actualizarTitulo() {
        const totalAlumnos = apoderados.reduce((total, ap) => total + ap.alumnos.length, 0);
        mainTitle.textContent = `${totalAlumnos} alumnos inscritos`;
        // Actualizar el título de la pestaña del navegador
        document.title = `Pagos (${totalAlumnos} alumnos)`;
    }
    
    // --- FUNCIONES DE RENDERIZADO Y UI ---
    
    function renderizarSelector() {
        apoderadoSelector.innerHTML = '';
        if (apoderados.length === 0) {
            apoderadoSelector.innerHTML = `<option disabled>No hay apoderados</option>`;
            return;
        }
        
        // Agrupar apoderados por día de la semana
        const apoderadosPorDia = {};
        const ordenDias = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
        
        // Inicializar días
        ordenDias.forEach(dia => {
            apoderadosPorDia[dia] = [];
        });
        
        // Agrupar apoderados
        apoderados.forEach((ap, index) => {
            apoderadosPorDia[ap.diaSemana].push({ ...ap, originalIndex: index });
        });
        
        // Renderizar por día
        ordenDias.forEach(dia => {
            if (apoderadosPorDia[dia].length > 0) {
                // Contar total de alumnos para este día
                const totalAlumnos = apoderadosPorDia[dia].reduce((total, ap) => total + ap.alumnos.length, 0);
                
                // Agregar separador de día (no seleccionable)
                const separador = document.createElement('option');
                separador.disabled = true;
                separador.style.fontWeight = 'bold';
                separador.style.backgroundColor = '#f0f0f0';
                separador.textContent = `${dia.toUpperCase()} (${totalAlumnos} alumnos)`;
                apoderadoSelector.appendChild(separador);
                
                // Agregar apoderados de este día
                apoderadosPorDia[dia].forEach(ap => {
                    const option = document.createElement('option');
                    option.value = ap.originalIndex;
                    
                    // Ordenar alumnos por horario (más temprano primero)
                    const alumnosOrdenados = [...ap.alumnos].sort((a, b) => a.hora.localeCompare(b.hora));
                    
                    // Formatear nombres según la cantidad de alumnos
                    let nombresTexto;
                    if (alumnosOrdenados.length === 1) {
                        nombresTexto = alumnosOrdenados[0].nombre;
                    } else if (alumnosOrdenados.length === 2) {
                        nombresTexto = `${alumnosOrdenados[0].nombre} y ${alumnosOrdenados[1].nombre}`;
                    } else {
                        const primeros = alumnosOrdenados.slice(0, -1).map(a => a.nombre).join(', ');
                        const ultimo = alumnosOrdenados[alumnosOrdenados.length - 1].nombre;
                        nombresTexto = `${primeros} y ${ultimo}`;
                    }
                    
                    option.textContent = `${ap.apoderado}, ${nombresTexto}`;
                    apoderadoSelector.appendChild(option);
                });
            }
        });
    }
    
    function displaySelectedInfo() {
        if (apoderadoSelector.value === '' || apoderados.length === 0) {
            selectedApoderadoInfo.classList.add('hidden');
            output.innerHTML = 'Aquí aparecerá el mensaje para copiar...'; // Borrar mensaje
            return;
        }
        const selected = apoderados[apoderadoSelector.value];
        // Ordenar alumnos por horario para mostrar consistentemente
        const alumnosOrdenados = [...selected.alumnos].sort((a, b) => a.hora.localeCompare(b.hora));
        selectedApoderadoInfo.innerHTML = `<b>Alumnos:</b> ${alumnosOrdenados.map(a => `${a.nombre} (${a.hora})`).join(', ')} | <b>Día:</b> ${selected.diaSemana}`;
        selectedApoderadoInfo.classList.remove('hidden');
        
        // Borrar el mensaje generado al cambiar de apoderado
        output.innerHTML = 'Aquí aparecerá el mensaje para copiar...';
    }

    // --- FUNCIONES DE DATOS Y LÓGICA ---
    
    function generarMensaje() {
        const index = apoderadoSelector.value;
        if (index === '' || apoderados.length === 0) { 
            output.innerHTML = "Por favor, selecciona un apoderado."; 
            return; 
        }
        const data = apoderados[index];
        const hoy = new Date();
        let fechaEvaluada = new Date(hoy);
        if (hoy.getDate() >= 15) fechaEvaluada.setMonth(fechaEvaluada.getMonth() + 1);
        const mesAEvaluar = meses[fechaEvaluada.getMonth()];
        const anioAEvaluar = fechaEvaluada.getFullYear();
        const diaClaseNumero = diasSemanaMap[data.diaSemana];
        let diasDeClase = [];
        let cursorFecha = new Date(anioAEvaluar, fechaEvaluada.getMonth(), 1);
        while (cursorFecha.getMonth() === fechaEvaluada.getMonth()) {
            if (cursorFecha.getDay() === diaClaseNumero && cursorFecha >= hoy) diasDeClase.push(cursorFecha.getDate());
            cursorFecha.setDate(cursorFecha.getDate() + 1);
        }
        if (diasDeClase.length === 0) { 
            output.innerHTML = `No quedan días "${data.diaSemana}" disponibles en ${mesAEvaluar}.`; 
            return; 
        }
        const cantidadAlumnos = data.alumnos.length;
        const listaDiasTexto = diasDeClase.map(dia => `${data.diaSemana} ${dia} x${cantidadAlumnos}`).join('\n');
        const valorFormateado = (diasDeClase.length * VALOR_CLASE * cantidadAlumnos).toLocaleString('es-CL');
        let fechaLimite = new Date(hoy);
        if (hoy.getDate() < 15) { fechaLimite.setDate(hoy.getDate() + 2); } 
        else { fechaLimite = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0); }
        const diaSemanaLimite = DIAS_SEMANA[fechaLimite.getDay()];
        const limiteFormateado = `${diaSemanaLimite} ${fechaLimite.getDate()} de ${meses[fechaLimite.getMonth()]}, 22:00 hrs`;
        // Ordenar alumnos por horario para el mensaje
        const alumnosOrdenados = [...data.alumnos].sort((a, b) => a.hora.localeCompare(b.hora));
        const alumnosTexto = alumnosOrdenados.map(alumno => `${alumno.nombre} (${alumno.hora})`).join('\n');
        
        // Crear el mensaje y convertir ** a negrita
        let mensaje = `*Hola ${data.apoderado}, te mando detalle para reservar los días de ${mesAEvaluar}:*\n\n${listaDiasTexto}\n\n${alumnosTexto}\n\nTotal\n*$${valorFormateado}*\n\nFecha límite de pago\n*${limiteFormateado}*`;
        
        // Convertir ** a <strong> para negrita y preservar saltos de línea
        mensaje = mensaje.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
        mensaje = mensaje.replace(/\n/g, '<br>');
        
        output.innerHTML = mensaje;
    }

    function copiarMensaje() {
        if (!output.innerHTML || output.innerHTML.includes("Por favor") || output.innerHTML === 'Aquí aparecerá el mensaje para copiar...') return;
        
        // Convertir HTML de vuelta a texto plano con formato WhatsApp
        let textoParaCopiar = output.innerHTML;
        textoParaCopiar = textoParaCopiar.replace(/<strong>(.*?)<\/strong>/g, '*$1*'); // Convertir <strong> a *texto*
        textoParaCopiar = textoParaCopiar.replace(/<br>/g, '\n'); // Convertir <br> a saltos de línea
        textoParaCopiar = textoParaCopiar.replace(/<[^>]*>/g, ''); // Remover cualquier otra etiqueta HTML restante
        
        // Función mejorada para móviles
        function copiarTexto(texto) {
            // Método 1: Navigator clipboard (funciona en HTTPS)
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(texto);
            } 
            // Método 2: Fallback para móviles y HTTP
            else {
                return new Promise((resolve, reject) => {
                    // Crear un textarea temporal
                    const textArea = document.createElement('textarea');
                    textArea.value = texto;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    
                    // En móviles, es mejor usar contentEditable
                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                        textArea.contentEditable = true;
                        textArea.readOnly = false;
                        const range = document.createRange();
                        range.selectNodeContents(textArea);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                        textArea.setSelectionRange(0, 999999);
                    } else {
                        textArea.select();
                    }
                    
                    try {
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (successful) {
                            resolve();
                        } else {
                            reject(new Error('Copy command failed'));
                        }
                    } catch (err) {
                        document.body.removeChild(textArea);
                        reject(err);
                    }
                });
            }
        }
        
        copiarTexto(textoParaCopiar).then(() => {
            const originalText = copyBtn.textContent;
            copyBtn.textContent = '¡Copiado!';
            setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
        }).catch(err => { 
            console.error('Error al copiar: ', err); 
            // Fallback final: mostrar el texto para copiar manualmente
            alert('No se pudo copiar automáticamente. Selecciona y copia el texto del área de mensaje.');
            
            // Seleccionar todo el texto en el div output para facilitar la copia manual
            const range = document.createRange();
            range.selectNodeContents(output);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        });
    }

    // --- EVENT LISTENERS ---
    generateBtn.addEventListener('click', generarMensaje);
    copyBtn.addEventListener('click', copiarMensaje);
    apoderadoSelector.addEventListener('change', displaySelectedInfo);
    
    // --- INICIALIZACIÓN ---
    actualizarTitulo();
    renderizarSelector();
    displaySelectedInfo();
    
});
</script>

</body>
</html>